// Sample project

#include <gb/gb.h>
#include "tiles.c"

// TODO: import tile and/or sprite and/or map data

// TODO: create variables to make a game
UINT8 playerX, playerY;
UINT8 enemyX, enemyY; 
UINT8 fireballX, fireballY, fireballVelocityX, fireballVelocityY, fireballIsActive;
UINT8 frameCounter; // framecounter for RNG purposes, it overflows, but who cares m8

unsigned char background[] = {
	0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 
	0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 
	0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 
	0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 
	0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 
	0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 
	0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 
	0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 
	0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08,
	0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08,
	0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08,
	0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08,
	0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08,
	0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08,
	0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08,
	0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08,
	0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08,
	0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08,
	0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08,
	0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08,
	0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08,
	0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08,
	0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08
};



void init() {
	
	DISPLAY_ON;

	set_bkg_data(0, 10, tile_data);
	set_bkg_tiles(0, 0, 20, 18, background);
	
	set_sprite_data(1, 4, tile_data);

	set_sprite_tile(0, 2);
	set_sprite_tile(1, 3);
	set_sprite_tile(2, 4);

	// Give player sprite priority
	set_sprite_prop(0, S_PRIORITY);

	// init variables
	playerX = 20;
	playerY = 20;

	enemyX = 128;
	enemyY = 128;

	fireballX = 255;
	fireballY = 255;

	fireballIsActive = 0;
}

// Check if two rectangles from x1,y1, and extending out h1, h2, 
//  overlap with another, x2,y2, and extending out w2, h2
UINT8 collisionCheck(UINT8 x1, UINT8 y1, UINT8 w1, UINT8 h1, UINT8 x2, UINT8 y2, UINT8 w2, UINT8 h2) {

	if ((x1 < (x2+w2)) && ((x1+w1) > x2) && (y1 < (h2+y2)) && ((y1+h1) > y2)) {
		return 1;
	} else {
		return 0;
	}
}

// custom function to handle user input and perform actions in the game
void handleInput() {
	// TODO: cool stuff
	
	// fire fireball
	if (joypad() & J_A && fireballIsActive == 0) {
		// Determine fireball direction
		fireballVelocityX = 0;
		fireballVelocityY = 0;

		if (joypad() & J_UP)
			fireballVelocityY = -2;
		if (joypad() & J_DOWN)
			fireballVelocityY = 2;
		if (joypad() & J_LEFT)
			fireballVelocityX = -2;
		if (joypad() & J_RIGHT)
			fireballVelocityX = 2;
		
		// Spawn fireball if opposing dpad directions are not being pressed at the same time
		if (fireballVelocityX != 0 || fireballVelocityY != 0) {
			fireballX = playerX + fireballVelocityX * 4;
			fireballY = playerY + fireballVelocityY * 4;
			fireballIsActive = 1;
		}
	}

	// move player up
	if (joypad() & J_UP && playerY > 16) {
		--playerY;
	}

	// move player down
	if (joypad() & J_DOWN && playerY < SCREENHEIGHT) {
		++playerY;
	}

	// move player left
	if (joypad() & J_LEFT && playerX > 8) {
		--playerX;
	}

	// move player right
	if (joypad() & J_RIGHT && playerX < SCREENWIDTH) {
		++playerX;
	}

	// reset the game when START is pressed
	if (joypad() & J_START) {
		reset();
	}


	// Update fireballs position
	fireballX += fireballVelocityX;
	fireballY += fireballVelocityY;

	// perform collision check for fireball and enemy
	// if they collide then 'despawn' the fireball by placing it offscreen and settings it's veloctiy to 0
	// The enemy will respawn at a random place on the screen
	if (collisionCheck(fireballX, fireballY, 8, 8, enemyX, enemyY, 8, 8)) {
		fireballX = 230;
		fireballY = 230;
		fireballVelocityX = 0;
		fireballVelocityY = 0;

		fireballIsActive = 0;

		enemyX = 16 + (frameCounter % 128);
		enemyY = 16 + (sys_time % 128);
	}

	// 'despawn' fireball when it flies offscreen
	if (fireballX > SCREENWIDTH + 8 || fireballY > SCREENHEIGHT + 32) {
		fireballX = 230;
		fireballY = 230;
		fireballVelocityX = 0;
		fireballVelocityY = 0;

		fireballIsActive = 0;
	}

	// Draw the sprites for Player, Enemy and Fireball
	move_sprite(0, playerX, playerY);
	move_sprite(1, enemyX, enemyY);
	move_sprite(2, fireballX, fireballY);

}

// Sets switches to show sprites and background
void updateSwitches() {
	HIDE_WIN;
	SHOW_SPRITES;
	SHOW_BKG;
}

void main() {
	
	init();
	
	// Game Loop
	while (1) {
		handleInput();
		updateSwitches();

		++frameCounter;

		wait_vbl_done();	// wait until v-blank is done to avoid corrupting memory
	}
}